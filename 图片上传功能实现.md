# ğŸ‰ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å·²å®ç°ï¼

## é‡å¤§æ›´æ–°

ç»è¿‡é€†å‘åˆ†æçŸ¥è¯†æ˜Ÿçƒ Web ç«¯çš„ç½‘ç»œè¯·æ±‚ï¼ŒæˆåŠŸå®ç°äº†å®Œæ•´çš„å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼

## âœ… æµ‹è¯•ç»“æœ

- **æµ‹è¯•æ—¶é—´**: 2025-11-10
- **æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡
- **Image ID**: 8855451815815122
- **Topic ID**: 14588282542545482
- **æŸ¥çœ‹åœ°å€**: https://wx.zsxq.com/group/28888188458521

## ğŸ”§ æŠ€æœ¯å®ç°

### API åˆ†æè¿‡ç¨‹

é€šè¿‡ç”¨æˆ·æ‰‹åŠ¨åœ¨æµè§ˆå™¨ä¸­ä¸Šä¼ å›¾ç‰‡å¹¶å‘å¸ƒä¸»é¢˜ï¼Œæ•è·åˆ°äº†å®Œæ•´çš„ API è°ƒç”¨æµç¨‹ï¼š

1. **ç¬¬ä¸€ä¸ªè¯·æ±‚** - è·å–ä¸Šä¼ ä»¤ç‰Œ
   ```bash
   POST https://api.zsxq.com/v2/uploads
   Content-Type: application/json

   {"req_data": {"type": "image", "size": 172211, "name": "", "hash": ""}}

   # å“åº”
   {"succeeded": true, "resp_data": {"upload_token": "..."}}
   ```

2. **ç¬¬äºŒä¸ªè¯·æ±‚** - ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
   ```bash
   POST https://upload-z1.qiniup.com/
   Content-Type: multipart/form-data

   # Form Data:
   - file: [å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®]
   - token: [ä»ç¬¬ä¸€æ­¥è·å–çš„upload_token]

   # å“åº”
   {"succeeded": true, "resp_data": {"image_id": 8855451815512552}}
   ```

3. **ç¬¬ä¸‰ä¸ªè¯·æ±‚** - å‘å¸ƒä¸»é¢˜
   ```bash
   POST https://api.zsxq.com/v2/groups/28888188458521/topics
   Content-Type: application/json

   {
     "req_data": {
       "type": "topic",
       "text": "æµ‹è¯•å‘å¸ƒå›¾ç‰‡\n",
       "image_ids": [8855451815512552],
       "file_ids": [],
       "mentioned_user_ids": []
     }
   }

   # å“åº”
   {"succeeded": true, "resp_data": {"topic": {"topic_id": 45811414854888228, ...}}}
   ```

### å…³é”®å‘ç°

1. **ä¸ƒç‰›äº‘å­˜å‚¨**: çŸ¥è¯†æ˜Ÿçƒä½¿ç”¨ä¸ƒç‰›äº‘ä½œä¸ºå›¾ç‰‡å­˜å‚¨æœåŠ¡
2. **ä»¤ç‰Œæœºåˆ¶**: éœ€è¦å…ˆä» ZSXQ API è·å–ä¸´æ—¶ä¸Šä¼ ä»¤ç‰Œ
3. **è·¨åŸŸä¸Šä¼ **: å›¾ç‰‡å®é™…ä¸Šä¼ åˆ° `upload-z1.qiniup.com`
4. **Image ID**: ä¸Šä¼ æˆåŠŸåä¸ƒç‰›äº‘è¿”å› image_idï¼Œç”¨äºå‘å¸ƒæ—¶å¼•ç”¨

## ğŸ“ ä»£ç å®ç°

### client.py æ›´æ–°

```python
async def upload_image(self, image_path: str) -> Dict[str, Any]:
    """
    Upload an image to ZSXQ using the correct 3-step process
    """
    file_path = Path(image_path)
    file_size = file_path.stat().st_size

    async with httpx.AsyncClient(timeout=30.0) as client:
        # Step 1: Get upload token from ZSXQ API
        token_response = await client.post(
            f"{self.BASE_URL}/v2/uploads",
            headers=self.headers,
            json={
                "req_data": {
                    "type": "image",
                    "size": file_size,
                    "name": "",
                    "hash": ""
                }
            }
        )
        upload_token = token_response.json()["resp_data"]["upload_token"]

        # Step 2: Upload to Qiniu Cloud
        with open(file_path, "rb") as f:
            files = {"file": (file_path.name, f, "image/jpeg")}
            data = {"token": upload_token}

            upload_response = await client.post(
                "https://upload-z1.qiniup.com/",
                files=files,
                data=data
            )

        image_id = upload_response.json()["resp_data"]["image_id"]

        return {"image_id": image_id}
```

## ğŸ¯ å¯ç”¨åŠŸèƒ½

### 1. å•ç‹¬ä¸Šä¼ å›¾ç‰‡

```python
upload_image(image_path="/path/to/image.jpg")
# è¿”å›: "âœ… Image uploaded successfully! Image ID: 8855451815815122"
```

### 2. å‘å¸ƒå¸¦å›¾ç‰‡çš„ä¸»é¢˜

```python
publish_topic_with_images(
    content="åˆ†äº«ç¾å›¾",
    image_paths=[
        "/path/to/image1.jpg",
        "/path/to/image2.png"
    ]
)
# è¿”å›: "âœ… Topic with 2 image(s) published successfully! Topic ID: ..."
```

### 3. åœ¨ Claude ä¸­ä½¿ç”¨

```
å¸®æˆ‘å‘å¸ƒä¸€æ¡å¸¦å›¾ç‰‡çš„åŠ¨æ€åˆ°çŸ¥è¯†æ˜Ÿçƒï¼Œå†…å®¹æ˜¯"ä»Šå¤©çš„æˆæœ"ï¼Œ
å›¾ç‰‡è·¯å¾„ï¼š/Users/xxx/screenshot.png
```

## ğŸ“Š å¯¹æ¯”

| åŠŸèƒ½ | ä¹‹å‰çŠ¶æ€ | ç°åœ¨çŠ¶æ€ |
|------|---------|---------|
| çº¯æ–‡å­—å‘å¸ƒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å›¾ç‰‡ä¸Šä¼  | âŒ ä¸æ”¯æŒ | âœ… å·²å®ç° |
| ä»æ–‡ä»¶å‘å¸ƒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å¤šå›¾ä¸Šä¼  | âŒ ä¸æ”¯æŒ | âœ… å·²å®ç° |
| è·å–æ˜Ÿçƒä¿¡æ¯ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

## ğŸ” é—®é¢˜è§£å†³è¿‡ç¨‹

### å°è¯•1: ç›´æ¥ä¸Šä¼  âŒ
æœ€åˆå°è¯•ç›´æ¥ä¸Šä¼ åˆ° ZSXQ APIï¼Œä½†è¿”å› 401/404 é”™è¯¯

### å°è¯•2: ç‰ˆæœ¬æ¨¡æ‹Ÿ âŒ
å°è¯•æ¨¡æ‹Ÿå®¢æˆ·ç«¯ç‰ˆæœ¬å·ï¼Œä½†ä»ç„¶è¿”å›"ç‰ˆæœ¬è¿‡æ—§"é”™è¯¯

### å°è¯•3: Playwright ç›‘æ§ âœ…
ä½¿ç”¨ Playwright æ‰“å¼€æµè§ˆå™¨ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œï¼Œç›‘æ§ç½‘ç»œè¯·æ±‚

### æœ€ç»ˆæ–¹æ¡ˆ: cURL åˆ†æ âœ…
ç”¨æˆ·æä¾›äº†å®Œæ•´çš„ cURL è¯·æ±‚ï¼ŒæˆåŠŸåˆ†æå‡ºä¸‰æ­¥ä¸Šä¼ æµç¨‹

## ğŸ“ ç»éªŒæ€»ç»“

1. **é€†å‘å·¥ç¨‹**: é€šè¿‡æµè§ˆå™¨å¼€å‘è€…å·¥å…·åˆ†æç½‘ç»œè¯·æ±‚æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„æ–¹æ³•
2. **cURL è½¬æ¢**: cURL å‘½ä»¤åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„è¯·æ±‚ä¿¡æ¯
3. **ç¬¬ä¸‰æ–¹æœåŠ¡**: çŸ¥è¯†æ˜Ÿçƒä½¿ç”¨ä¸ƒç‰›äº‘ï¼Œéœ€è¦å…ˆè·å–ä»¤ç‰Œå†ä¸Šä¼ 
4. **è·¨åŸŸè¯·æ±‚**: ä¸Šä¼ è¯·æ±‚çš„ç›®æ ‡æ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ï¼Œheaders éœ€è¦è°ƒæ•´

## ğŸ“„ ç›¸å…³æ–‡ä»¶

- `src/zsxq_mcp/client.py` - å®ç°äº† `upload_image` æ–¹æ³•
- `src/zsxq_mcp/server.py` - æ·»åŠ äº† `publish_topic_with_images` å’Œ `upload_image` å·¥å…·
- `README.md` - æ›´æ–°äº†åŠŸèƒ½è¯´æ˜å’ŒæŠ€æœ¯å®ç°

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
- âœ… å‘å¸ƒçº¯æ–‡å­—åŠ¨æ€
- âœ… å‘å¸ƒå¸¦å›¾ç‰‡çš„åŠ¨æ€
- âœ… ä¸Šä¼ å¤šå¼ å›¾ç‰‡
- âœ… ä»æ–‡ä»¶è¯»å–å†…å®¹å‘å¸ƒ
- âœ… é€šè¿‡ Claude å¯¹è¯è‡ªåŠ¨å‘å¸ƒ

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼ğŸ‰
